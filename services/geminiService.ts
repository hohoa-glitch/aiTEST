import { GoogleGenAI, Type } from "@google/genai";
import { VideoAnalysisResponse, TargetAudience } from "../types";

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

// Helper to convert File to Base64
const fileToGenerativePart = async (file: File): Promise<{ inlineData: { data: string; mimeType: string } }> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => {
      const result = reader.result as string;
      const base64String = result.split(',')[1];
      resolve({
        inlineData: {
          data: base64String,
          mimeType: file.type,
        },
      });
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
};

export const generateHookTitles = async (videoFile: File, audience: TargetAudience): Promise<VideoAnalysisResponse> => {
  try {
    const videoPart = await fileToGenerativePart(videoFile);

    // Prompt Strategy Selection
    let systemInstruction = "";

    if (audience === 'KOREAN') {
      systemInstruction = `
        ë‹¹ì‹ ì€ ìœ íŠœë¸Œ ì•Œê³ ë¦¬ì¦˜ì„ ì™„ë²½í•˜ê²Œ íŒŒì•…í•˜ê³  ìˆëŠ” **'ì¡°íšŒìˆ˜ ì „ë¬¸ ì»¨ì„¤í„´íŠ¸'**ì…ë‹ˆë‹¤.
        ì´ ì˜ìƒì˜ ì œëª©ê³¼ ì„¤ëª…ì„ ì‘ì„±í•˜ëŠ” **ìœ ì¼í•œ ëª©ì ì€ í•œêµ­ ì‹œì²­ìë“¤ì˜ ì¡°íšŒìˆ˜(Views)ì™€ í´ë¦­ë¥ (CTR)ì„ ê·¹ëŒ€í™”**í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

        ì²¨ë¶€ëœ ì˜ìƒì„ ì •ë°€ ë¶„ì„í•˜ì—¬, í•œêµ­ì¸ì´ ë¬´ì¡°ê±´ í´ë¦­í•  ìˆ˜ë°–ì— ì—†ëŠ” 'ì œëª©', 'ì„¤ëª…ê¸€', 'ì„ ì • ì´ìœ ', 'í•´ì‹œíƒœê·¸' **5ê°€ì§€ ì„¸íŠ¸**ë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”.

        ### ğŸš€ ë¶„ì„ ë° ìƒì„± ì§€ì¹¨ (Korean Target):

        1.  **ì œëª© (Title) - í´ë¦­ ìœ ë„ 1ìˆœìœ„**:
            *   **ëª©í‘œ**: í•œêµ­ ì¸í„°ë„· ë°ˆ, ì •ì„œ, ìœ í–‰ì–´, í˜¸ê¸°ì‹¬ì„ ìê·¹í•˜ì—¬ ìŠ¤í¬ë¡¤ì„ ë©ˆì¶”ê²Œ í•˜ì„¸ìš”.
            *   **ì „ëµ**:
                *   **í˜¸ê¸°ì‹¬ ê²©ì°¨**: ê²°ê³¼ë‚˜ í•µì‹¬ì„ ì‚´ì§ ìˆ¨ê²¨ í´ë¦­ ìœ ë„.
                *   **ê°•ë ¬í•œ ë‹¨ì–´**: "ì¶©ê²©", "ê²°êµ­", "ì ˆëŒ€", "ë¯¸ì³¤ë‹¤", "ã…ã„·ã„·", "ì‹¤í™”ëƒ", "ì°¸êµìœ¡" ë“± ì‹œì„ ì„ ë„ëŠ” ë‹¨ì–´ ì ì ˆíˆ ë°°ì¹˜.
                *   **ê¸¸ì´**: ëª¨ë°”ì¼ ê°€ë…ì„±ì„ ìœ„í•´ 25ì ì´ë‚´ ê¶Œì¥.
            *   *í”¼í•´ì•¼ í•  ê²ƒ*: ë²ˆì—­íˆ¬, ë”±ë”±í•œ ë¬¸ì¥, ë„ˆë¬´ ë»”í•œ ì„¤ëª…ì‹ ì œëª©.

        2.  **ì„¤ëª…ê¸€ (Description)**:
            *   í•œêµ­ì–´ ê²€ìƒ‰(SEO) ìµœì í™” í‚¤ì›Œë“œ í¬í•¨.
            *   ì˜ìƒ ì´ˆë°˜ì˜ ì¬ë¯¸ìˆëŠ” í¬ì¸íŠ¸ë¥¼ í…ìŠ¤íŠ¸ë¡œ ìš”ì•½í•˜ì—¬ ë”ë³´ê¸° í´ë¦­ ìœ ë„.

        3.  **íƒœê·¸ (Tags) - ê²€ìƒ‰ ìœ ì… í•µì‹¬**:
            *   ë‹¨ìˆœíˆ ì˜ìƒ ë‚´ìš©ì„ ë‚˜ì—´í•˜ëŠ” íƒœê·¸ëŠ” ê¸ˆì§€í•©ë‹ˆë‹¤. (ì˜ˆ: #ê³ ì–‘ì´ (X) -> #ê³ ì–‘ì´ì°¸êµìœ¡ #ê°œëƒ¥ì´ #ë¨¼ì¹˜í‚¨ (O))
            *   **ì „ëµ**: ì˜ìƒ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ì‹¤ì œ ì‚¬ëŒë“¤ì´ ìœ íŠœë¸Œ ê²€ìƒ‰ì°½ì— ì¹  ë²•í•œ **'ëŒ€í˜• í‚¤ì›Œë“œ'(ê²€ìƒ‰ëŸ‰ ë§ìŒ)**ì™€ **'ìƒí™©ë³„ í‚¤ì›Œë“œ'**ë¥¼ ì¡°í•©í•˜ì„¸ìš”.
            *   ì˜ìƒì˜ ì¹´í…Œê³ ë¦¬(ë¨¹ë°©, ë¸Œì´ë¡œê·¸, ê²Œì„ ë“±) ë‚´ ì¸ê¸° íƒœê·¸ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ì„¸ìš”.

        4.  **ì„ ì • ì´ìœ  (Reasoning)**:
            *   í•œêµ­ ìœ íŠœë¸Œ íŠ¸ë Œë“œ ê´€ì ì—ì„œ ì´ ì œëª©ê³¼ íƒœê·¸ê°€ ì™œ í„°ì§ˆ ìˆ˜ë°–ì— ì—†ëŠ”ì§€ ë¶„ì„.
      `;
    } else {
      // GLOBAL STRATEGY
      systemInstruction = `
        ë‹¹ì‹ ì€ ì „ ì„¸ê³„ ì‹œì²­ìë¥¼ íƒ€ê²Ÿìœ¼ë¡œ í•˜ëŠ” **'ê¸€ë¡œë²Œ ìœ íŠœë¸Œ ë°”ì´ëŸ´ ì „ëµê°€'**ì…ë‹ˆë‹¤.
        ì´ ì˜ìƒì˜ ì£¼ì²´ëŠ” ì‹¤ì œ ë™ë¬¼ì´ ì•„ë‹ˆë¼ **'AIë¡œ ì œì‘ëœ ìºë¦­í„°/ì• ë‹ˆë©”ì´ì…˜'**ì…ë‹ˆë‹¤.
        ë”°ë¼ì„œ "ìš°ë¦¬ì§‘ ê³ ì–‘ì´ê°€~" ê°™ì€ ì‹¤ì œ ë°˜ë ¤ë™ë¬¼ ë¸Œì´ë¡œê·¸ ê°ì„±ì´ ì•„ë‹ˆë¼, **ìºë¦­í„°ê°€ ì²˜í•œ 'ìƒí™©', 'ìŠ¤í† ë¦¬', 'í–‰ë™'** ê·¸ ìì²´ì— ì§‘ì¤‘í•´ì•¼ í•©ë‹ˆë‹¤.

        ì²¨ë¶€ëœ ì˜ìƒì„ ë¶„ì„í•˜ì—¬, ì–¸ì–´ì˜ ì¥ë²½ì„ ë„˜ì–´ í´ë¦­ì„ ìœ ë„í•˜ëŠ” 'ì œëª©', 'ì„¤ëª…ê¸€', 'ì„ ì • ì´ìœ ', 'í•´ì‹œíƒœê·¸' **5ê°€ì§€ í›„ë³´**ë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”.

        ### ğŸŒ ê¸€ë¡œë²Œ ë¶„ì„ ë° ìƒì„± ì§€ì¹¨ (Global Target):

        1.  **ì œëª© (Title) - ì°ì¹œ ëª¨ë“œ & ì´ˆì••ì¶•**:
            *   **êµ¬ì¡°**: ë°˜ë“œì‹œ **"í•œêµ­ì–´ ì œëª© | English Title"** ìˆœì„œë¡œ ì‘ì„±í•˜ì„¸ìš”. (íŒŒì´í”„ë¼ì¸ | êµ¬ë¶„ì ì‚¬ìš©)
            *   **ìŠ¤íƒ€ì¼**: ì–µì§€ìŠ¤ëŸ¬ìš´ ë²ˆì—­íˆ¬ë‚˜ "OOí•˜ëŠ” ì˜ìƒ" ê°™ì€ ì„¤ëª…ì¡°ë¥¼ í”¼í•˜ê³ , **ìƒí™© ê·¸ ìì²´ì˜ ì¬ë¯¸ë‚˜ í™©ë‹¹í•¨**ì„ ìì—°ìŠ¤ëŸ½ê²Œ í‘œí˜„í•˜ì„¸ìš”.
            *   **ì£¼ì˜ ì‚¬í•­**: **"ã…‹ã…‹ã…‹", "ã…ã…ã…" ê¸ˆì§€.** ë¬¸ì¥ì€ ë˜ë„ë¡ ì§§ê³  ê°„ê²°í•˜ê²Œ.
            *   **í•œêµ­ì–´ (Korean)**: 
                *   **ìì—°ìŠ¤ëŸ¬ìš´ êµ¬ì–´ì²´**: ì¹œêµ¬ì—ê²Œ ë³´ì—¬ì£¼ë©° "ì´ê±° ë´"ë¼ê³  í•  ë•Œ ì“¸ë²•í•œ ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸êµ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
                *   ì˜ˆì‹œ: "ì´ ìƒí™© ë­”ë°? | What is this?" (O)
                *   ì˜ˆì‹œ: "AIê°€ ê³ ì¥ ë‚¬ë‹¤ | AI Glitch?" (O)
            *   **ì˜ì–´ (English)**: **3~5ë‹¨ì–´ ì´ë‚´**ì˜ ì‰½ê³  ì§ê´€ì ì¸ ì˜ì–´.

        2.  **ì„¤ëª…ê¸€ (Description) - 3ê°œ êµ­ì–´ (ì˜ì–´, í•œêµ­ì–´, ì¼ë³¸ì–´)**:
            *   **ì¤‘ìš”**: **[English], [í•œêµ­ì–´], [æ—¥æœ¬èª] ê°™ì€ ë¼ë²¨(í—¤ë”)ì„ ì ˆëŒ€ ë¶™ì´ì§€ ë§ˆì„¸ìš”.** ê·¸ëƒ¥ ìì—°ìŠ¤ëŸ½ê²Œ ì¤„ë°”ê¿ˆë§Œ í•´ì„œ 3ê°œ êµ­ì–´ë¥¼ ë‚˜ì—´í•˜ì„¸ìš”.
            *   **ìˆœì„œ**: **ì˜ì–´ (ë‹¨ë½ 1) -> (ì¤„ë°”ê¿ˆ) -> í•œêµ­ì–´ (ë‹¨ë½ 2) -> (ì¤„ë°”ê¿ˆ) -> ì¼ë³¸ì–´ (ë‹¨ë½ 3)**
            *   **ê³µí†µ ì£¼ì˜ ì‚¬í•­**: **"ã…‹ã…‹ã…‹", "OMG" ë“± ê³¼ë„í•œ ê°íƒ„ì‚¬ ê¸ˆì§€.** ì°¨ë¶„í•˜ì§€ë§Œ í¥ë¯¸ë¡­ê²Œ **ìƒí™© ì„¤ëª…**ì— ì§‘ì¤‘í•˜ì„¸ìš”.
            
            *   **ì˜ì–´ (English)**: ìƒí™©ì„ ìˆëŠ” ê·¸ëŒ€ë¡œ ë¬˜ì‚¬í•˜ëŠ” ì§§ê³  ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥.
            
            *   **í•œêµ­ì–´ (Korean)**:
                *   **ë§íˆ¬**: **"~í•´ìš”", "~ë„¤ìš”"** ê°™ì€ ì¹œì ˆí•˜ê³  ë¶€ë“œëŸ¬ìš´ ë§íˆ¬ ì‚¬ìš©. ë„ˆë¬´ ì¥ë‚œìŠ¤ëŸ½ì§€ ì•Šìœ¼ë©´ì„œë„ ë‹¤ì •í•˜ê²Œ.
                *   **í˜ë¥´ì†Œë‚˜**: **"ì„¼ìŠ¤ ìˆê³  ë‹¤ì •í•œ 30ëŒ€ í¬ë¦¬ì—ì´í„°"**ê°€ êµ¬ë…ìì—ê²Œ ìƒí™©ì„ ì„¤ëª…í•´ì£¼ë“¯ì´. ê·€ì—¬ìš´ ì´ëª¨ì§€ 1~2ê°œ ì‚¬ìš©.
                *   ë‚´ìš©: AI ìºë¦­í„°ì˜ í–‰ë™ì´ë‚˜ í‘œì •, ìƒí™©ì˜ ë°˜ì „ í¬ì¸íŠ¸ ì„¤ëª….

            *   **ì¼ë³¸ì–´ (Japanese)**:
                *   ì¹œì ˆí•œ **"~ì…ë‹ˆë‹¤/í•©ë‹ˆë‹¤(Desu/Masu)"**ì²´ë¥¼ ì‚¬ìš©.
                *   ì¼ë³¸ íŠ¹ìœ ì˜ ë¶€ë“œëŸ¬ìš´ ê°ì„±ê³¼ ê·€ì—¬ìš´ ì´ëª¨ì§€ ì‚¬ìš©.

        3.  **íƒœê·¸ (Tags) - ê¸€ë¡œë²Œ ë¯¹ìŠ¤**:
            *   ì˜ìƒì˜ **ì‹œê°ì  ìš”ì†Œ(Visuals)**ì™€ **í–‰ë™(Action)**ì„ ë¶„ì„í•˜ì—¬ í•´ë‹¹ ë‹ˆì¹˜(Niche)ì—ì„œ ê°€ì¥ **ê²€ìƒ‰ëŸ‰ì´ ë§ì€ ì˜ì–´ íƒœê·¸**ë¥¼ ì°¾ì•„ë‚´ì„¸ìš”.
            *   **AI ê´€ë ¨ íƒœê·¸ í¬í•¨**: #AIArt, #AIAnimation, #VirtualCharacter ë“± AI ê´€ë ¨ íƒœê·¸ë¥¼ ì ì ˆíˆ ì„ìœ¼ì„¸ìš”.
            *   **ë¹„ìœ¨**: **ì˜ì–´ íƒœê·¸ 70% + í•œêµ­ì–´ íƒœê·¸ 30%**.
            *   #shorts, #fyp, #trending ê°™ì€ ê³µí†µ íƒœê·¸ í¬í•¨.

        4.  **ì„ ì • ì´ìœ  (Reasoning)**:
            *   ì´ ì œëª© êµ¬ì„±ì´ ì™œ í•œêµ­ì¸ê³¼ ì™¸êµ­ì¸ ëª¨ë‘ì˜ í´ë¦­ì„ ìœ ë„í•˜ëŠ”ì§€ ë¶„ì„.
      `;
    }

    const response = await ai.models.generateContent({
      model: 'gemini-2.5-flash',
      contents: {
        parts: [
          videoPart,
          {
            text: `
              ${systemInstruction}

              ê²°ê³¼ëŠ” ë°˜ë“œì‹œ ì•„ë˜ JSON ìŠ¤í‚¤ë§ˆì— ë§ì¶°ì„œ ë°˜í™˜í•´ì£¼ì„¸ìš”.
            `
          }
        ]
      },
      config: {
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.OBJECT,
          properties: {
            suggestions: {
              type: Type.ARRAY,
              items: {
                type: Type.OBJECT,
                properties: {
                  title: { type: Type.STRING, description: "í´ë¦­ë¥ ì„ ê·¹ëŒ€í™”í•˜ëŠ” ìœ íŠœë¸Œ ì œëª©" },
                  description: { type: Type.STRING, description: "3ê°œ êµ­ì–´(ì˜ì–´, í•œêµ­ì–´, ì¼ë³¸ì–´)ë¡œ ì‘ì„±ëœ ì„¤ëª…ê¸€ (ë¼ë²¨ ì—†ì´ ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)" },
                  reasoning: { type: Type.STRING, description: "ì„ ì • ì´ìœ  ë° ì „ëµ ë¶„ì„" },
                  tags: { type: Type.ARRAY, items: { type: Type.STRING }, description: "ì¡°íšŒìˆ˜ì™€ ê²€ìƒ‰ ìœ ì…ì„ ë¶€ë¥´ëŠ” ê³ íš¨ìœ¨ í•´ì‹œíƒœê·¸ (ì˜ìƒ ë‚´ìš© ë¶„ì„ ê¸°ë°˜)" }
                },
                required: ["title", "description", "reasoning", "tags"]
              }
            }
          }
        }
      }
    });

    if (response.text) {
      return JSON.parse(response.text) as VideoAnalysisResponse;
    } else {
      throw new Error("No response text generated");
    }

  } catch (error) {
    console.error("Gemini API Error:", error);
    throw error;
  }
};